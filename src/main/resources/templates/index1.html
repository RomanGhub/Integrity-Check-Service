<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!--<meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' http:/localhost:8080;">-->
<body>

<!--<iframe src="http://localhost/4040/jobs" width="600" height="400" sandbox="allow-same-origin"></iframe>-->
<!--<object data="http://localhost:4040/jobs" width="600" height="400" type="text/html"></object>-->

<!--<div id="sparkContent"></div>-->

<!--<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>-->
<!--<script>-->
<!--    $(document).ready(function() {-->
<!--        // Use jQuery to load Spark's UI content and inject it into the page-->
<!--        $('#sparkContent').load('http://localhost:4040/jobs');-->
<!--    });-->
<!--</script>-->

<!--/////////////-->

<!-- Dropzone Container -->
<form id="myDropzone" class="dropzone">
    <div class="fallback">
        <input name="file" type="file" multiple />
    </div>
    <!--    test-->
    <!--    <p>Hello, <span th:text="${name}">User</span>!</p>-->
</form>

<span>Знизу наведені доступні для виконання алгоритми перевірки цілісності.</span>
<!-- Container to display the list of uploaded files -->
<div id="fileList" style="margin-top: 30px"></div>

<!--///////////-->
<br>
<br>
<hr>
<hr>
<br>
<br>
<!--///////////-->

<!-- Second Dropzone Container -->
<form id="mySecondDropzone" class="dropzone">
    <div class="fallback">
        <input name="secondFile" type="file" multiple />
    </div>
</form>

<span>Знизу наведені доступні для перевірки цілісності масиви даних.</span>
<!-- Container to display the second list of uploaded files -->
<div id="dataArrayList" style="margin-top: 30px"></div>

<br>
<br>
<br>
<br>
<!--&lt;!&ndash; Include Dropzone.js &ndash;&gt; integrity="sha512-cnFS2D0OlW5YFuzSo6sAy8E5LC0x0O0bP3Qo8+ULl/44cwMRGfCvrkU0pXdKq7Yb4PQph3d8VfzLKm2Jo/FE8g=="-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.2/min/dropzone.min.js" integrity="sha512-VQQXLthlZQO00P+uEu4mJ4G4OAgqTtKG1hri56kQY1DtdLeIqhKUp9W/lllDDu3uN3SnUNawpW7lBda8+dSi7w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
<head>
    <meta charset="UTF-8">
    <title>File Uploader</title>
    <!-- Include Dropzone.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.2/min/dropzone.min.css" integrity="sha512-WvVX1YO12zmsvTpUQV8s7ZU98DnkaAokcciMZJfnNWyNzm7//QRV61t4aEr0WdIa4pe854QHLTV302vH92FSMw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<script>
    // Customize this URL to point to your Spring Boot controller
    let uploadUrl = "http://localhost:8080/api/files/upload";
    let uploadedFiles = [];

    let selectedDataArray;

    // Initialize Dropzones
    Dropzone.options.myDropzone = {
        paramName: "file", // The name that will be used to transfer the file
        maxFilesize: 20, // MB
        acceptedFiles: ".jar", // Specify file types allowed
        dictDefaultMessage: "Перетягніть сюди .jar архіви з імплементованим алгоритмом.", // Set your custom message here
        url: function (files) {
            // Append the filename as a query parameter to the upload URL
            return uploadUrl + "?filename=" + encodeURIComponent(files[0].name) + "&isDataArray=false";
        }, //uploadUrl,
        init: function () {
            this.on("success", function (file, response) {
                console.log("File uploaded successfully:", response);
                uploadedFiles.push(file.name);
                updateFileList();
            });
            this.on("error", function (file, errorMessage) {
                console.error("Error uploading file:", errorMessage);
            });
        }
    };
    Dropzone.options.mySecondDropzone = {
        paramName: "file", // The name that will be used to transfer the file
        maxFilesize: 20000, // MB
        // acceptedFiles: ".jar", // Specify file types allowed
        dictDefaultMessage: "Перетягніть сюди масив даних, перевірку цілісності якого ви хочете здійснити.", // Set your custom message here
        url: function (files) {
            // Append the filename as a query parameter to the upload URL
            return uploadUrl + "?filename=" + encodeURIComponent(files[0].name) + "&isDataArray=true";
        }, //uploadUrl,
        init: function () {
            this.on("success", function (file, response) {
                console.log("Data array uploaded successfully:", response);
                uploadedFiles.push(file.name);
                updateDataArrayList();
            });
            this.on("error", function (file, errorMessage) {
                console.error("Error uploading data array:", errorMessage);
            });
        }


    };

    function updateFileList() {
        // Clear existing buttons
        document.getElementById("fileList").innerHTML = "";

        // Create container for each uploaded file with a text field
        for (let i = 0; i < uploadedFiles.length; i++) {
            let filename = uploadedFiles[i];
            if (!filename.endsWith(".jar")) {
                continue;
            }

            // Create a container div
            let container = document.createElement("div");
            // Set style for container
            container.classList.add("dataArrayContainer");

            // Create button for the file
            let button = document.createElement("button");
            button.innerText = filename;
            button.style.marginRight = "20px";
            button.addEventListener("click", function () {
                runAlgorithm(filename, selectedDataArray, this);
            });

            // Create text field
            let textField = document.createElement("input");
            textField.type = "text";
            textField.placeholder = "Введіть попередньо обчислений ключ/хеш/суму для перевірки цілісності.";
            textField.style.width = "452px";

            // Append button and text field to the container
            container.appendChild(button);
            container.appendChild(textField);

            // Append container to the file list container
            document.getElementById("fileList").appendChild(container);
        }
    }

    function updateDataArrayList() {
        // Clear existing buttons
        document.getElementById("dataArrayList").innerHTML = "";

        // Create container for each uploaded file with a button and a text field
        for (let i = 0; i < uploadedFiles.length; i++) {
            let filename = uploadedFiles[i];
            if (filename.endsWith(".jar")) {
                continue;
            }

            // Create a container div
            let container = document.createElement("div");
            // set style for container
            container.classList.add("dataArrayContainer");

            // Create button for the file
            let button = document.createElement("button");
            button.innerText = filename;
            button.addEventListener("click", function () {
                // Call a function to handle the selection (e.g., selectFile)
                selectFile(filename);
            });

            // Create text field
            // let textField = document.createElement("input");
            // textField.type = "text";
            // textField.placeholder = "Enter text here";

            // Append button and text field to the container
            container.appendChild(button);
            // container.appendChild(textField);

            // Append container to the second file list container
            document.getElementById("dataArrayList").appendChild(container);
        }
    }
    function selectFile(selectedFilename) {
        selectedDataArray = selectedFilename;
        // Implement your logic to handle the selection here
        // For example, you can highlight the selected file or perform other actions
        console.log("Selected data array:", selectedFilename);
    }

/*    function updateFileList() { //old
        // Clear existing buttons
        document.getElementById("fileList").innerHTML = "";

        // Create buttons for each uploaded file
        for (let i = 0; i < uploadedFiles.length; i++) {
            let filename = uploadedFiles[i];
            let button = document.createElement("button");
            button.innerText = filename;
            button.addEventListener("click", function () {
                runAlgorithm(filename);
            });

            // Append button to the file list container
            document.getElementById("fileList").appendChild(button);
        }
    }*/

    function runAlgorithm(filename, dataArray, buttonElement) {
        // Make an AJAX call to the /run endpoint with the selected filename
        // You can use libraries like Axios or Fetch API for this
        // Example using Fetch API:
        // Prepare the data to be sent
        const textFieldValue = buttonElement.nextElementSibling.value;

        const data = new FormData();
        data.append('filename', filename);
        data.append('dataArray', dataArray);
        data.append('precalculatedHash', textFieldValue);

        fetch("http://localhost:8080/api/files/run", {  //?filename=" + encodeURIComponent(filename)
            method: "POST",
/*            headers: {
                "Content-Type": "application/x-www-form-urlencoded", // Adjust the content type as needed
            },*/
/*            body: JSON.stringify({
                "filename": encodeURIComponent(filename),
                "dataArray": dataArray
            }),*/
            body: data
        })
            .then(response => response.json())
            .then(data => {
                alert("Algorithm ran successfully. Calculated rootHash is: " + data + " ; \n Expected hash is: " + textFieldValue);
                console.log(data);
                // Handle the response as needed
            })
            .catch(error => {
                console.error("Error running algorithm:", error);
            });
    }

    // Load existing files on page load
    window.onload = function () {
        loadExistingFiles();
        setTimeout(function() {}, 500);
        loadExistingDataArrays();
    };

    function loadExistingFiles() {
        fetch("http://localhost:8080/api/files/listOfFiles")
            .then(response => response.json())
            .then(data => {
                // 'data' should be an array of file names
                if (data) {
                    uploadedFiles = data;
                    updateFileList();
                }
            })
            .catch(error => {
                console.error("Error fetching file names:", error);
            });
    }

    function loadExistingDataArrays() {
        fetch("http://localhost:8080/api/files/listOfData")
            .then(response => response.json())
            .then(data => {
                // 'data' should be an array of file names
                if (data) {
                data.forEach((array, index) => {
                        uploadedFiles.push(array);
                        updateDataArrayList();
                    })
                }
            })
            .catch(error => {
                console.error("Error fetching file names:", error);
            });
    }

</script>

<style>
    /* Add your other styles here */

    .dataArrayContainer {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f7f7f7;
    }

    .dataArrayContainer button {
        /* Style for the button inside dataArrayContainer */
        color: #333;
        background-color: #fff;
        /* Add more styles as needed */
    }

    .dataArrayContainer input {
        /* Style for the text field inside dataArrayContainer */
        margin-top: 5px;
        padding: 5px;
        width: 200px;
        /* Add more styles as needed */
    }

    #myDropzone, #mySecondDropzone {
        max-width: 300px; /* Set the maximum width */
        margin: 20px; /* Center the dropzone horizontally */
    }

    /*#myDropzone {*/
    /*    width: 100%; !* Set the width of individual previews to 100% *!*/
    /*    margin: 20px; !* Remove margin for previews *!*/
    /*}*/
</style>

</html>
